---
id: configuring-keycloak
title: Configure Keycloak
description: |
  How to configure Keycloak, add new users, add new groups and update roles.
---

## Introduction to Keycloak

[Keycloak](https://www.keycloak.org/) is the open-source identity and access management tool that comes standard with Nebari. It is used as a centralized location to add new users, create user groups and update roles and permissions. Keycloak can be configured to work with your existing identity provider services such as GitHub, Auth0 and many others.

:::note
Although Nebari allows you to connect with GitHub and Auth0 from the `nebari-config.yaml`, any identity provider that Keycloak can connect to will work. See these [Keycloak docs](https://www.keycloak.org/docs/latest/server_admin/#_identity_broker) for more information.
:::

In Keycloak, as with many admin tools, you start with an initial login user (`root`) that has the ability to administer and create new users. The `root` user is a Keycloak-specific user. It can only be used to log in and manage the Keycloak identity management section of Nebari.

:::warning
Trying to log in to JupyterHub using this `root` user will fail. Currently, this is the only user with access to the Keycloak administration console, therefore anyone wanting to add users, new groups, etc., will need to use this user and login here: `https://{your-nebari-domain}/auth/admin/`.
:::

## Change Keycloak root password

:::warning
Once you change the root password you will not be able to [add users from the command line](#add-user-from-the-command-line)
:::

`root`'s password is generated by the `nebari init` command. If you ran this command while following the steps under [Installing Nebari][nebari-install], you should have seen something like the following in your terminal output:

```bash
Securely generated default random password=<alphanumeric-string> for Keycloak root user
```

The `init` command also saves the root user password to your `nebari-config.yaml` configuration file under the following path:

`security.keycloak.initial_root_password`

After the initial deployment, it is **highly** recommended that you change the Keycloak `root` user password as soon as possible.

1. To change the `root` user password, go to your Nebari instance's admin dashboard - e.g., something like `https://{your-nebari-domain}/auth/admin/` and log in with the root password provided.

   <p align="center">
   <img src="/img/how-tos/keycloak_master_login.png" alt="Nebari admin view - Root Login to Keycloak form" width="400"/>
   </p>

2. From there, click on the **Root** dropdown in the top right of the screen, and select **Manage account**.

   ![Keycloak root user page - manage account tab selected](/img/how-tos/keycloak_root_user_manage_account.png)

3. Under **Account Security** click **Signing In**.

   ![Keycloak root user page - account security](/img/how-tos/keycloak_root_user_account_security.png)

4. In the Password section, click the **Update** button. This will guide you through entering your existing root password, and then creating a new password.

   ![Keycloak root user page - account security, update password](/img/how-tos/keycloak_root_user_update_password.png)

:::warning
The `security.keycloak.initial_root_password` field in `nebari-config.yaml` has no effect after changing the `root` password. If you redeploy Nebari it **will not reset** the password back to the old one (or anything else that might be in the field in your YAML file). We strongly recommend you delete this field to prevent later confusion.
:::

## Adding a Nebari user

No Nebari user is created for you during deployment, you will need to add a Nebari user manually in order to [log in to JupyterHub][keycloak-login] and access the other Nebari services.

If you have chosen to use GitHub, Auth0 or any other single-sign-on, you must ensure the value you enter in Keycloak under `Username` exactly matches the username from GitHub or Auth0, respectively.

### Add user using Keycloak admin console

To add a Nebari user from the Keycloak admin console, visit `https://{your-nebari-domain}/auth/admin/` and login using the username `root`, as shown above.

Keycloak uses [realms](https://www.keycloak.org/docs/latest/server_admin/#configuring-realms) to separate their permission scopes under the Keycloak admin console. The realm for Nebari is `nebari` and all Nebari users will be part of the `nebari` realm, on the other hand, the realm for the Keycloak admin console is `master`.

:::note
The root user alone is a member of the `master` realm. For security best practices, we recommend that you minimize the number of users in the `master` realm. See the [Master realm Keycloak documentation](https://www.keycloak.org/docs/latest/server_admin/#the-master-realm) for more information.
:::

The `nebari` realm is selected by default, we strongly recommend leaving it as is.

Steps to create a new user:

1. Click **Users** along the left-hand side of the page.

2. Click the **Add user** button, and you will see the new user form:

   ![Keycloak add user tab screenshot - new user form](/img/how-tos/keycloak_add_users.png)

3. Fill out the three fields outlined above. These are **Username**, **Email**, and **Groups**. (See explanation below). Then click **save**.

   - Username: Depending on the authentication provider selected ('password', 'GitHub' or 'Auth0'), the values entered into the **Username** field will differ slightly. The following table outlines
     those differences:

     |          | Password          | GitHub            | Auth0                 |
     | -------- | ----------------- | ----------------- | --------------------- |
     | Username | _unique username_ | _GitHub username_ | _Email to login with_ |

   - Once the **Username** field is updated, add a valid email address in the **Email** field.

:::note
Although not required, users may not be able to log in to Grafana if this field isn't properly set.
:::

- Associate the user with one or more of the **Groups**. Out of the box, Nebari is deployed with the following groups: `admin`, `developer` and `analyst` (see the [Roles x Groups](#in-depth-look-at-roles-and-groups) section below for more details).

4. Click **Save**.

If you are using the password authentication provider, you will also need to define a password for the user. It's best to put the **Temporary** toggle in the **OFF** position. Otherwise, the user will be forced to change the password on first login.

:::note
If using Auth0, GitHub or any other identity provider, the password field is not required.
:::

![Keycloak add user > credentials tab screenshot - set password](/img/how-tos/keycloak_user_password.png)

### Add user from the command line

:::warning
If you [changed the initial root password for Keycloak](#change-keycloak-root-password) this method will not work.
:::

To make adding users easier for new Nebari deployments, we've created a CLI command to help you.

```shell
nebari keycloak -c nebari-config.yaml adduser <username> <password>
```

This will create a new user `<username>` under the `analyst` group, with the initial password provided. Omit the password completely if you are using GitHub or Auth0. It will also add a placeholder email (i.e. `username@your-domain`) to the **Email** field.

## Login to Nebari

Your new user can now log in to Nebari, visit your provided Nebari domain URI which will take you to the login form page and follow the [How-to login in to Nebari and start a server][keycloak-login].

![Nebari - Log in to Keycloak page](/img/how-tos/nebari_login_screen.png)

## In-depth look at Roles and Groups

Groups represent a collection of users that perform similar actions and therefore require similar permissions. By default, Nebari is deployed with the following groups: `admin`, `developer`, and `analyst` (in roughly descending order of permissions and scope).

:::info
Users in a particular group will also get access to that groups shared folder. So if `user A` belongs to the `developer`, they will also have access to the `~/shared/developer` folder. This also applies to new groups that you create.
:::

Roles on the other hand represent the type or category of user. This includes access and permissions that this category of user will need to perform their regular job duties. The differences between `groups` and `roles` are subtle. Particular roles (one or many), like `conda_store_admin`, are associated with a particular group, such as `admin` and any user in this group will then assume the role of `conda_store_admin`.

:::info
These roles can be stacked. This means that if a user is in one group with role `conda_store_admin` and another group with role `conda_store_viewer`, this user ultimately has the role `conda_store_admin`.
:::

| Group        | Access to Nebari Resources                                                                                     | Roles                                                                                                                                                                     | Permissions Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ------------ | -------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `analyst`    | <ul><li>Conda-Store</li><li>Jupyterhub</li><li>Argo Workflows</li><li>Grafana</li></ul>                        | <ul><li>`conda_store_developer`</li><li>`jupyterhub_developer`</li><li>`argo_viewer`</li><li>`grafana_viewer`</li></ul>                                                   | <ul><li>Default user permissions</li><li>Access to start a server instance and generate JupyterHub access token.</li><li>Read/write access to shared `analyst` folder group mount</li><li>Read access to `analyst` and write access to personal conda-store namespace</li><li>Read access to Argo-Workflows and Jupyter-Scheduler </li><li>Inherent Grafana permissions from [Grafana viewer scopes](https://grafana.com/docs/grafana/latest/administration/roles-and-permissions/#organization-roles)</li></ul> |
| `developer`  | <ul><li>Conda-Store</li><li>Dask</li><li>Jupyterhub</li><li>Argo Workflows</li><li>Grafana Developer</li></ul> | <ul><li>`conda_store_developer`</li><li>`dask_developer`</li><li>`jupyterhub_developer`</li><li>`argo_developer`</li><li>`grafana_developer`</li></ul>                    | <ul><li>All of the above access, plus...</li><li>Read access `developer` conda-store namespace</li><li>Access to create Dask clusters.</li><li>Read/write access to shared `developer` folder group mount</li><li>Read/create access to Argo-Workflows and Jupyter-Scheduler</li><li>Inherent Grafana permissions from [Grafana editor scopes](https://grafana.com/docs/grafana/latest/administration/roles-and-permissions/#organization-roles)</li></ul>                                                       |
| `admin`      | <ul><li>Conda-Store</li><li>Dask</li><li>Jupyterhub</li><li>Argo Workflows</li><li>Grafana</li></ul>           | <ul><li>`conda_store_admin`</li><li>`dask_admin`</li><li>`jupyterhub_admin`</li><li>`argo_admin`</li><li>`grafana_admin`</li></ul>                                        | <ul><li>All of the above access, plus...</li><li>Read/write access to all conda-store available namespaces/environments.</li><li>Access to Jupyterhub Admin page and can access JupyterLab users spaces</li><li>Access to Keycloak and can add remove users and groups</li><li>Inherent Grafana permissions from [Grafana administrator scopes](https://grafana.com/docs/grafana/latest/administration/roles-and-permissions/#organization-roles)</li></ul>                                                      |
| `superadmin` | <ul><li>Conda-Store</li><li>Dask</li><li>Jupyterhub</li><li>Argo Workflows</li><li>Grafana</li></ul>           | <ul><li>`conda_store_superadmin`</li><li>`dask_admin`</li><li>`jupyterhub_admin`</li><li>`argo_admin`</li><li>`realm_admin` (Keycloak) </li><li>`grafana_admin`</li></ul> | <ul><li>All of the above access, plus...</li><li>Delete (build and environment) access on conda-store</li><li>Full access to Keycloak (realm) (same as `root`)</li></ul>                                                                                                                                                                                                                                                                                                                                         |

:::info
Check [Conda-store authorization model](https://conda-store.readthedocs.io/en/latest/contributing.html#authorization-model) for more details on conda-store authorization.
:::

:::caution
The role `jupyterhub_admin` gives users elevated permissions to JupyterHub and should be applied judiciously. As mentioned in the table above, a JupyterHub admin is able to impersonate other users and view the contents of their home folder. For more details, read through the [JupyterHub documentation](https://z2jh.jupyter.org/en/stable/jupyterhub/customizing/user-management.html#admin-users).
:::

To create new groups or modify (or delete) existing groups, log in as `root` and click **Groups** on the left-hand side.

As an example, we create a new group named `conda-store-manager`. This group will have administrator access to the [Conda-Store service].

1. Click **New** in the upper-right hand corner under **Groups**.

![Keycloak groups tab screenshot - user groups view](/img/how-tos/keycloak_groups.png)

- Then, give the new group an appropriate name.

![Keycloak add group form - name field set to conda-store-manager](/img/how-tos/keycloak_new_group1.png)

2. Under **Role Mapping**, add the appropriate **Client Roles** as needed; there should be no need to update the **Realm Roles**.

![Keycloak group conda-store-manager form - role mappings tab focused with expanded client roles dropdown](/img/how-tos/keycloak_new_group2.png)

In this example, the new group only has one mapped role, `conda_store_admin`; however, it's possible to attach multiple **Client Roles** to a single group.

![Keycloak group conda-store-manager form - role mappings tab focused ](/img/how-tos/keycloak_new_group3.png)

Once complete, return to the **Users** section in the dashboard and add the relevant users to this newly created group.

<!-- internal links -->

[keycloak-login]: /docs/tutorials/login-keycloak
[nebari-install]: /docs/get-started/installing-nebari.md

### Keycloak Identity Providers (IDPs) and Debugging Social Login Issues

When integrating Keycloak with external Identity Providers (IDPs) like GitHub, Auth0, or
other social login providers, you might encounter issues during the authentication
process. To effectively troubleshoot and resolve these issues, it's helpful to enable
detailed logging of the user profiles received from these external IDPs.

Keycloak provides a logger category `org.keycloak.social.user_profile_dump` that, when
enabled, logs the user profile information obtained from the social provider. This
detailed logging can be invaluable for debugging authentication issues, mapping user
attributes, and ensuring the correct data is being received.

#### Enabling Detailed Logging for Social Logins

To enable detailed logging for social logins in Keycloak, adjust the logging
configuration to set the logger level for `org.keycloak.social.user_profile_dump` to
`DEBUG`.

1. **Access the Keycloak Configuration Directory**:
   Access the Keycloak container's filesystem or use volume mounts to modify configuration files. The `standalone.xml` configuration file is typically located at:

   ```
   /opt/jboss/keycloak/standalone/configuration/standalone.xml
   ```

   ```shell
   bash-4.4$ pwd
   /opt/jboss/keycloak/standalone/configuration
   bash-4.4$ ls -la
   total 120
   drwxrwxr-x 1 jboss root  4096 Nov 13 15:49 .
   drwxrwxr-x 1 jboss root  4096 Nov 16  2021 ..
   -rw-rw---- 1 jboss root   711 Aug 20  2021 application-roles.properties
   -rw-rw---- 1 jboss root   935 Aug 20  2021 application-users.properties
   drwxr-xr-x 2 jboss root  4096 Nov 13 15:48 keystores
   -rw-rw-r-- 1 jboss root  1426 Nov 13 15:49 logging.properties
   -rw-rw---- 1 jboss root   669 Aug 20  2021 mgmt-groups.properties
   -rw-rw---- 1 jboss root  1112 Aug 20  2021 mgmt-users.properties
   -rw-r--r-- 1 jboss root 38883 Nov 13 15:48 standalone-ha.xml
   -rw-r--r-- 1 jboss root 34670 Nov 13 15:48 standalone.xml
   drwxr-xr-x 5 jboss root  4096 Nov 13 15:49 standalone_xml_history
   ```

2. **Modify the Logging Subsystem Configuration**:

   Open the `standalone.xml` file with a text editor. Locate the `<subsystem xmlns="urn:jboss:domain:logging:">` section. Within the logging subsystem, add the
   following logger configuration:

   ```xml
   <logger category="org.keycloak.social.user_profile_dump">
       <level name="DEBUG"/>
   </logger>
   ```

   The modified section might look like this:

   ```xml
   ...
   <subsystem xmlns="urn:jboss:domain:logging:7.0">
       <console-handler name="CONSOLE">
           <level name="INFO"/>
           <formatter>
               <named-formatter name="COLOR-PATTERN"/>
           </formatter>
       </console-handler>
       <!-- Add social user_profile_dump to log -->
       <logger category="org.keycloak.social.user_profile_dump">
           <level name="DEBUG"/>
       </logger>
       <!-- Other existing loggers and configurations -->
   ...
   ```

3. **Save and Restart Keycloak**:

   After saving the changes to the `standalone.xml` file, restart the Keycloak pod by
   restarting the pod. The changes will take effect after the restart.

   :::note
   The keycloak pod might not contain any usual editor like `vim` or `nano`. You can
   instead use a debugging pod with the same volume mounts to edit the file. For
   example, you can use the following command to open a shell in the Keycloak pod:

   ```shell
   kubectl debug keycloak-0 -n <nebari-namespace> --copy-to=my-debugger --set-image=*=busybox
   ```

4. **Review the Logs**:

   With the logger enabled, attempt to authenticate using the social login that was causing issues. The detailed user profile information received from the IDP will now be logged, helping you identify missing attributes, incorrect mappings, or other discrepancies.

#### Tips:

- **Security Considerations**: Be cautious when enabling debug-level logging in production environments, as it may log sensitive information. Ensure logs are appropriately secured and consider disabling debug logging once issues are resolved.

- **Alternative Methods**: You can also adjust logging levels via the Keycloak admin console under the "Server Info" > "Logging" section, although this may not persist across restarts unless properly configured.

---

### Using Identity Provider (IDP) Mappers in Keycloak

Identity Provider (IDP) mappers in Keycloak are powerful tools that allow you to control how user data from external IDPs is mapped into the Keycloak user model during authentication. When users authenticate via an external IDP, such as a social login or another OpenID Connect provider, IDP mappers define how attributes and claims from the IDP are transformed and stored in Keycloak.

#### Understanding IDP Mappers

- **What Are IDP Mappers?**

  IDP mappers are configurations within Keycloak that map identity provider data to Keycloak user attributes, roles, and other metadata.

- **Why Use IDP Mappers?**

  They enable you to:

  - **Map Attributes**: Synchronize user profile information from the IDP to Keycloak.
  - **Assign Roles**: Automatically assign roles to users based on IDP claims.
  - **Transform Usernames**: Modify or set the Keycloak username based on IDP data.

#### Common Use Cases

- **Mapping User Attributes**: Import user attributes like email, first name, and last name from the IDP.

- **Assigning Roles**: Grant roles to users based on claims such as group memberships.

- **Username Refactoring**: Adjust usernames to ensure uniqueness or comply with naming conventions.

#### How to Configure IDP Mappers

To configure IDP mappers in Keycloak:

1. **Navigate to the Identity Provider Configuration**:

   - Log in to the Keycloak admin console.
   - Select your realm.
   - Go to the "Identity Providers" section.
   - Click on the identity provider you have configured (e.g., GitHub, Google).

2. **Access the Mappers Tab**:

   - In the IDP configuration page, switch to the "Mappers" tab.
   - This tab lists existing mappers and allows you to create new ones.

3. **Add a New Mapper**:

   - Click on the "Add Mapper" button.
   - You will be presented with a form to configure the new mapper.

4. **Configure the Mapper**:

   - **Name**: Provide a descriptive name for the mapper.
   - **Mapper Type**: Select the appropriate mapper type (e.g., "Attribute Importer", "Role Importer", "Username Template Importer").
   - **Set Mapper Configurations**: Configure the specific settings based on the mapper type.

#### Examples of IDP Mappers

##### 1. **Attribute Importer**

- **Purpose**: Map an IDP claim to a Keycloak user attribute.

- **Configuration**:

  - **Mapper Type**: `User Attribute Importer`
  - **Claim**: The claim name from the IDP (e.g., `email`, `name`).
  - **User Attribute Name**: The Keycloak user attribute to map to (e.g., `email`, `firstName`).

- **Example**:

  Mapping the `email` claim from the IDP to the Keycloak `email` attribute.

##### 2. **Role Importer**

- **Purpose**: Assign Keycloak roles based on IDP claims.

- **Configuration**:

  - **Mapper Type**: `Advanced Claim to Role`
  - **Role**: The Keycloak role to assign.
  - **Claim**: The IDP claim to evaluate (e.g., `groups`, `roles`).
  - **Claim Value**: The expected value to trigger role assignment.

- **Example**:

  If the IDP claim `groups` contains `admin`, assign the Keycloak role `realm-admin`.

##### 3. **Username Template Importer**

- **Purpose**: Define or transform the Keycloak username based on IDP data.

- **Configuration**:

  - **Mapper Type**: `Username Template Importer`
  - **Template**: A template string using variables from IDP claims (e.g., `${CLAIM.preferred_username}`).
  - **Target**: Where to apply the template (e.g., `username`).

- **Example**:

  Setting the Keycloak username to the user's email from the IDP:

  - **Template**: `${CLAIM.email}`

#### Relating IDP Mappers to OpenID Connect Claims

- **OpenID Connect Claims**: These are pieces of information about the user provided by the IDP (e.g., `email`, `name`, `sub`).

- **Mapping Claims to Keycloak**: IDP mappers allow you to extract these claims and map them to appropriate fields in Keycloak.

- **Custom Claims**: If the IDP provides custom claims, you can map them to custom user attributes in Keycloak.

#### Assigning Roles Based on Claims

- **Use Case**: Automatically assign roles to users based on their attributes or group memberships in the IDP.

- **Steps**:

  1. Identify the claim containing role or group information.
  2. Create a Role Importer mapper in Keycloak.
  3. Configure the mapper to assign a Keycloak role when the claim matches certain conditions.

- **Example**:

  - If the IDP claim `department` equals `IT`, assign the role `it-department` to the user.

#### Creating User Attributes

- **Use Case**: Store additional user information from the IDP in Keycloak user attributes.

- **Steps**:

  1. Determine the claims you want to import.
  2. Use the Attribute Importer mapper to map these claims to Keycloak user attributes.

- **Example**:

  - Map the `employee_id` claim from the IDP to a custom Keycloak user attribute `employeeId`.

#### Refactoring the Username During Login

- **Use Case**: Adjust the Keycloak username to match organizational standards or ensure uniqueness.

- **Steps**:

  1. Use the Username Template Importer mapper.
  2. Define a template that constructs the username based on IDP claims or other data.

- **Examples**:

  - **Appending IDP Alias**: `${ALIAS}.${CLAIM.preferred_username}` results in usernames like `github.johndoe`.
  - **Using Email**: `${CLAIM.email}` sets the username to the user's email address.

#### Tips for Using IDP Mappers

- **Order Matters**: The order of mappers can affect the outcome. Keycloak processes mappers in the order they appear.

- **Test and Validate**: After configuring mappers, test the login flow to ensure that attributes and roles are correctly assigned.

- **Logging**: Use detailed logging (as described earlier) to debug and verify the claims received from the IDP.

- **Custom Mappers**: If the built-in mapper types do not meet your needs, consider developing custom mappers using Keycloak's Service Provider Interface (SPI).

#### Security Considerations

- **Sensitive Data**: Be cautious when mapping sensitive data from IDP claims to Keycloak attributes. Ensure appropriate security measures are in place.

- **Data Privacy**: Comply with data protection regulations by only storing necessary user information and informing users about data usage.

---

By leveraging IDP mappers in Keycloak, you can tailor the authentication process to suit your application's requirements, ensuring seamless integration with external identity providers and consistent user experiences.
