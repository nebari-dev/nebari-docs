---
id: configuring-keycloak
title: Configure Keycloak
description: |
  How to configure Keycloak, add new users, add new groups and update roles.
---

## Introduction to Keycloak

[Keycloak](https://www.keycloak.org/) is the open-source identity and access management tool that comes standard with Nebari. It is used as a centralized location to add new users, create user groups and update roles and permissions. Keycloak can be configured to work with your existing identity provider services such as GitHub, Auth0 and many others.

:::note
Although Nebari allows you to connect with GitHub and Auth0 from the `nebari-config.yaml`, any identity provider that Keycloak can connect to will work. See these [Keycloak docs](https://www.keycloak.org/docs/latest/server_admin/#_identity_broker) for more information.
:::

In Keycloak, as with many admin tools, you start with an initial login user (`root`) that has the ability to administer and create new users. The `root` user is a Keycloak-specific user. It can only be used to log in and manage the Keycloak identity management section of Nebari.

:::warning
Trying to log in to JupyterHub using this `root` user will fail. Currently, this is the only user with access to the Keycloak administration console, therefore anyone wanting to add users, new groups, etc., will need to use this user and login here: `https://{your-nebari-domain}/auth/admin/`.
:::

## Change Keycloak root password

:::warning
Once you change the root password you will not be able to [add users from the command line](#add-user-from-the-command-line)
:::

`root`'s password is generated by the `nebari init` command. If you ran this command while following the steps under [Installing Nebari][nebari-install], you should have seen something like the following in your terminal output:

```bash
Securely generated default random password=<alphanumeric-string> for Keycloak root user
```

The `init` command also saves the root user password to your `nebari-config.yaml` configuration file under the following path:

`security.keycloak.initial_root_password`

After the initial deployment, it is **highly** recommended that you change the Keycloak `root` user password as soon as possible.

1. To change the `root` user password, go to your Nebari instance's admin dashboard - e.g., something like `https://{your-nebari-domain}/auth/admin/` and log in with the root password provided.

   <p align="center">
   <img src="/img/how-tos/keycloak_master_login.png" alt="Nebari admin view - Root Login to Keycloak form" width="400"/>
   </p>

2. From there, click on the **Root** dropdown in the top right of the screen, and select **Manage account**.

   ![Keycloak root user page - manage account tab selected](/img/how-tos/keycloak_root_user_manage_account.png)

3. Under **Account Security** click **Signing In**.

   ![Keycloak root user page - account security](/img/how-tos/keycloak_root_user_account_security.png)

4. In the Password section, click the **Update** button. This will guide you through entering your existing root password, and then creating a new password.

   ![Keycloak root user page - account security, update password](/img/how-tos/keycloak_root_user_update_password.png)

:::warning
The `security.keycloak.initial_root_password` field in `nebari-config.yaml` has no effect after changing the `root` password. If you redeploy Nebari it **will not reset** the password back to the old one (or anything else that might be in the field in your YAML file). We strongly recommend you delete this field to prevent later confusion.
:::

## Adding a Nebari user

No Nebari user is created for you during deployment, you will need to add a Nebari user manually in order to [log in to JupyterHub][keycloak-login] and access the other Nebari services.

If you have chosen to use GitHub, Auth0 or any other single-sign-on, you must ensure the value you enter in Keycloak under `Username` exactly matches the username from GitHub or Auth0, respectively.

### Add user using Keycloak admin console

To add a Nebari user from the Keycloak admin console, visit `https://{your-nebari-domain}/auth/admin/` and login using the username `root`, as shown above.

Keycloak uses [realms](https://www.keycloak.org/docs/latest/server_admin/#configuring-realms) to separate their permission scopes under the Keycloak admin console. The realm for Nebari is `nebari` and all Nebari users will be part of the `nebari` realm, on the other hand, the realm for the Keycloak admin console is `master`.

:::note
The root user alone is a member of the `master` realm. For security best practices, we recommend that you minimize the number of users in the `master` realm. See the [Master realm Keycloak documentation](https://www.keycloak.org/docs/latest/server_admin/#the-master-realm) for more information.
:::

The `nebari` realm is selected by default, we strongly recommend leaving it as is.

Steps to create a new user:

1. Click **Users** along the left-hand side of the page.

2. Click the **Add user** button, and you will see the new user form:

   ![Keycloak add user tab screenshot - new user form](/img/how-tos/keycloak_add_users.png)

3. Fill out the three fields outlined above. These are **Username**, **Email**, and **Groups**. (See explanation below). Then click **save**.

   - Username: Depending on the authentication provider selected ('password', 'GitHub' or 'Auth0'), the values entered into the **Username** field will differ slightly. The following table outlines
     those differences:

     |          | Password          | GitHub            | Auth0                 |
     | -------- | ----------------- | ----------------- | --------------------- |
     | Username | _unique username_ | _GitHub username_ | _Email to login with_ |

   - Once the **Username** field is updated, add a valid email address in the **Email** field.

:::note
Although not required, users may not be able to log in to Grafana if this field isn't properly set.
:::

- Associate the user with one or more of the **Groups**. Out of the box, Nebari is deployed with the following groups: `admin`, `developer` and `analyst` (see the [Roles x Groups](#in-depth-look-at-roles-and-groups) section below for more details).

4. Click **Save**.

If you are using the password authentication provider, you will also need to define a password for the user. It's best to put the **Temporary** toggle in the **OFF** position. Otherwise, the user will be forced to change the password on first login.

:::note
If using Auth0, GitHub or any other identity provider, the password field is not required.
:::

![Keycloak add user > credentials tab screenshot - set password](/img/how-tos/keycloak_user_password.png)

### Add user from the command line

:::warning
If you [changed the initial root password for Keycloak](#change-keycloak-root-password) this method will not work.
:::

To make adding users easier for new Nebari deployments, we've created a CLI command to help you.

```shell
nebari keycloak  adduser -c nebari-config.yaml --user <username> <password>
```

This will create a new user `<username>` under the `analyst` group, with the initial password provided. Omit the password completely if you are using GitHub or Auth0. It will also add a placeholder email (i.e. `username@your-domain`) to the **Email** field.

## Login to Nebari

Your new user can now log in to Nebari, visit your provided Nebari domain URI which will take you to the login form page and follow the [How-to login in to Nebari and start a server][keycloak-login].

![Nebari - Log in to Keycloak page](/img/how-tos/nebari_login_screen.png)

<!-- internal links -->

[keycloak-login]: /docs/tutorials/login-keycloak
[nebari-install]: /docs/get-started/installing-nebari.md
